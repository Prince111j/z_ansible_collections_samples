# Ansible Collection - ibm.ibm_zos_wazi_deploy

# The Deploy Ansible playbooks  

These Ansible playbooks are YAML files that deploy the application updates detected by Wazi Deploy to the target z/OS environment. If you need explanations about Wazi Deploy, refer to the [Wazi Deploy Documentation](https://ibmdocs-test.mybluemix.net/docs/en/wazi_deploy_first_test).  

The Ansible playbooks available at this level are developed and maintained by IBM and must not be modified.  

They read the deployment plan generated by Wazi Deploy. For the description of the deployment plan, refer to [The deployment plan](https://ibmdocs-test.mybluemix.net/docs/en/wazi_deploy_first_test?topic=files-deployment-plan) in the Wazi Deploy Documentation.  


## Prerequisites

The following tools are required for the generation of the Ansible playbooks and the execution of these playbooks on the distributed system:
   - Python 3.8.0 or greater.
   - Ansible Core 2.11.0 or greater. You can install Ansible with the following command:
```pip3 install ansible```
   - Ansible for Z. You need to install the required packages with the following commands:
      - ```ansible-galaxy collection install ibm.ibm_zos_core```. See: https://galaxy.ansible.com/ibm/ibm_zos_core.
      - ```ansible-galaxy collection install ibm.ibm_zos_cics```. See: https://galaxy.ansible.com/ibm/ibm_zos_cics.
    
 **Notes:**   
    - **Do not install the beta versions of the z/OS collection, such as version 1.4.x for the zos_core**.   
    - The CICS Ansible collection for Z needs the `xmltodict` Python module. If it is not already installed, install it with the following command:   
      ```pip3 install xmltodict```   
    - The Wazi Deploy generated playbooks use advanced Ansible queries. You must also install this Python package with the following command:   
      ```pip3 install jmespath```

## Overview of the Wazi Deploy Ansible playbooks

The deployment entry point is the ``wd_deploy.yml`` playbook, which calls the other playbooks: ``wd_activitity.yml``, ``wd_action.yml``, and ``wd_step.yml``.   
 
   
The deployment steps that are listed in the deployment plan must be implemented in the Ansible playbooks located in the ``tasks`` folder. Each step listed in the deployment plan must be implemented in a playbook. If no playbook exists to implement the step, the deployment fails.  
The Ansible playbooks available at this level and in the ``tasks`` folder contain variables that must be assigned values in the `inventories` folder.   


When an Ansible playbook runs, it can produce pieces of information that can be queried after the deployment to analyze the deployment process and results. These pieces of information are called evidence. They are gathered in an evidence file. This evidence file is structured according what is specified in the ``cb_evidences.py `` file in the ``callback_plugins`` subfolder.   
For information about this evidence file and how to query its content to analyze the deployment, see [The evidence file](https://ibmdocs-test.mybluemix.net/docs/en/wazi_deploy_first_test?topic=files-evidence-file) in the Wazi Deploy documentation. To enable the production of evidence by default, the ``ansible.cfg`` file must contain the following line:   
```stdout_callback = cb_evidences```    
This line is present in the ``ansible.cfg`` file provided by default. However, you must add it if you create your own ``ansible.cfg`` file.  

The ``files`` and ``filter_plugins`` subfolders are internal and must not be modified.


## How to start the Ansible deployment command

Before you start the deployment, make sure that the following requirements are met:   
   - All the playbooks that are required for your deployment are available in the ``tasks`` folder. If not, you must create the missing playbooks.   
   - The variables used by the playbooks must be valued in the ``inventories`` folder. If you create your own playbooks, make sure that you assign values to all the variables they use.

Once you are sure that the requirements are met, you can start the deployment by running the following command in Ansible:  
``ansible-playbook wd_deploy.yml``   
followed by its arguments:  
   - ``-i inventories`` to provide the variables of the playbooks
   - ``-e wd_deployment_plan_file=<path to deployment_plan.yml>`` to specify the path to the generated deployment plan.
   - ``-e wd_package_file=<path to the package.tar>`` to specify the path to the package file that contains the updated artifacts of the application. If your deployment corresponds to deletions only, there is no package file ; so in this case you do not specify this argument.
  
Here is a sample of the deployment command:   
```
ansible-playbook wd_deploy.yml -i inventories\   
  -e wd_deployment_plan_file=inputs/deployment_plan_add.yml\  
  -e wd_package_file=inputs/package.add.tar   
```
